create or replace function same_especialidades() returns trigger AS

$$
	begin
		if new.num_cedula != null and
		new.num_doente != null and
		new.data != null and
		new.num_analise not in (SELECT DISTINCT num_analise FROM (analise NATURAL JOIN consulta) AS 						tabl,medico AS m
					WHERE m.num_cedula = tabl.num_cedula AND m.especialidade = tabl.especialidade)
		then
		
		raise exception'Especialidade do medico nao corresponde a especialidade da consulta na analise',new.num_analise;
		end if;
	return new
	end;

$$
Language plpgsql;

create trigger same_especialidades_trigger() before insert on analise for each row execute procedure same_especialidades()
